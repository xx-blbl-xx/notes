### archlinux安装

```bash
# 查看联网情况
ip address
# 更新系统时间
timedatectl set-ntp true
## 查看当前时间
date
# 磁盘分区
## 查看磁盘列表
fdisk -l
## 开始分区
fdisk /dev/sdx
## 选择分区类型与大小(mbr分区，如果需要uefi启动需要GPT分区)
o n p w
## 格式化分区
mkfs.ext4 /dev/sdxY
## 挂载分区
mount /dev/sdxY /mnt
# 更换镜像源(把前面几个非中国的镜像源干掉)
vim /etc/pacman.d/mirrorlist
# 安装基本包
pacstrap /mnt base base-devel linux linux-firmware
# 配置fstab
genfstab -L /mnt >> /mnt/etc/fstab
## 检查配置
cat /mnt/etc/fstab
# 进入新系统
arch-chroot /mnt
# 设置时区
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
hwclock --systohc
# 安装必要软件包
pacman -S vim
# 设置主机名
vim /etc/hostname
# 添加密码
passwd
# 安装bootloader，后面两个为探测可能存在的windows
pacman -S grub os-prober ntfs-3g
grub-install /dev/sdx
grub-mkconfig -o /boot/grub/grub.cfg
## 检查系统入口
vim /boot/grub/grub.cfg
# 退出到启动盘 卸载目录 重启
exit
umount /mnt/boot
umount /mnt
reboot

# 启动网络相关
systemctl start systemd-networkd
systemctl enable systemd-networkd
# 查看网卡信息
ip address
# 为想要接入网络的网卡配置网络，文件名prefix最好小于70避免被系统覆盖
# 配置一张连接外网的网卡
vim /etc/systemd/network/50-dhcp.network
# [Match]
# Name=enp0s1 #网卡名

# [Link]
# RequiredForOnline=routable #确保其有一个可路由的ip配置，有可用ip段

# [Network]
# DHCP=yes #从dhcp服务获取配置
# #LinkLocalAddressing=ipv4 #关闭ipv6
# #IPv6AcceptRA=no #关闭ipv6
# #DNS=180.184.1.1 180.184.2.2 #单独配置dns

# 配置一张连接内网的网卡
vim /etc/systemd/network/60-static.network
# [Match]
# Name=enp0s2

# [Network]
# Address=192.168.128.2/24 #指定ip
# #Gateway=192.168.128.1 #不要再配置网关
# #DNS=114.114.114.114
# #IPv6AcceptRA=no

# 查看路由表，多数情况下需要确保只有一条默认路由配置
ip route
#默认路由类似 default via 10.23.136.1 dev enp0s1 proto dhcp src 10.23.138.59 metric 1024

# 重启网络服务
systemctl restart systemd-networkd
# 理论上网络配置通过后systemd-networkd-wait-online.service为active (exited)状态
systemctl status systemd-networkd-wait-online.service

# 启动域名解析服务相关
systemctl start systemd-resolved
systemctl enable systemd-resolved
vim /etc/systemd/resolved.conf
# [Resolve]
# DNS=114.114.114.114 223.5.5.5 #为本地域名解析提供默认配置
# Domains=~. #优先查询本地域名解析服务，尤其是使用本地网络时，可以直接解析机器名

# 重启域名解析服务
systemctl restart systemd-resolved
# 检查dns信息
resolvectl dns
# 输出类似
# Global: 114.114.114.114 223.5.5.5
# Link 2 (enp0s1): 10.23.193.249 10.23.193.250
# Link 3 (enp0s2):

# 测试域名解析服务是否正常
resolvectl query bilibili.com
# 有时虚拟机dhcp配置的dns信息不准确会导致域名解析经常为内网地址，或者配置了ipv6的dns地址但是无法正常解析时可以考虑停用网卡的ipv6

# 安装常用软件
pacman -S docker docker-compose openssh git zsh inetutils netcat bind

# 启动sshd
systemctl start sshd
systemctl enable sshd
# 启用密码登录
vim /etc/ssh/sshd_config
# 对应注释部分后边补上下边三行：
# LoginGraceTime 120
# PermitRootLogin yes
# StrictModes yes
systemctl restart sshd

# 安装oh-my-zsh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

# 复制公钥
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.128.2
# 关闭密码登录
vim /etc/ssh/sshd_config
systemctl restart sshd

# 确定docker daemon配置文件地址
systemctl cat docker.service
# 添加proxy
vim /usr/lib/systemd/system/docker.service
# ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --http-proxy='http://192.168.128.1:7890' --https-proxy='http://192.168.128.1:7890'
systemctl daemon-reload
systemctl restart docker.service
# 启动各种容器
docker-compose -f dbs.yml start
docker ps
# 开机启动docker
systemctl enable docker.socket
systemctl enable docker.service
# 去掉proxy并启用远程管理端口（不加密）,远端测试 docker -H tcp://192.168.128.1:2375 ps
vim /usr/lib/systemd/system/docker.service
# ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375 --containerd=/run/containerd/containerd.sock
systemctl daemon-reload
systemctl restart docker.service

# 重启机器
systemctl reboot
# 查看系统状态，如果状态为degraded则是可能有服务未能正常启动需要排查，直到再次重启后变为running
systemctl status
# 关机后更改虚拟机配置
systemctl poweroff

# gui可选：安装wifi wpa认证 shell_ui 网络管理工具
pacman -S wpa_supplicant dialog networkmanager
# 可选：安装Intel-ucode dhcp客户端
pacman -S intel-ucode dhcpcd
# 安装显卡驱动
pacman -S xf86-video-intel
# 安装xorg
pacman -S xorg
# 安装KDE桌面环境
pacman -S plasma kde-applications
# 安装分辨率插件
pacman -S kscreen
# 启动桌面环境
startx
```

> https://wiki.archlinux.org/title/Installation_guide
> https://wiki.archlinuxcn.org/zh-sg/%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97
> https://man.archlinux.org/man/systemd.network.5
> https://wiki.archlinux.org/title/IPv6
> https://wiki.archlinux.org/title/Network_configuration
> https://wiki.archlinux.org/title/GRUB
> https://wiki.archlinuxcn.org/wiki/GRUB
> https://wiki.archlinux.org/title/Systemd-resolved
